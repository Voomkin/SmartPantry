<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">SmartPantry/screens/Home.js | My Library</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="this is awesome library"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="My Library"><meta property="twitter:description" content="this is awesome library"><meta property="twitter:image" content="http://my-library.org/logo.png"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Voomkin/SmartPantry"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-createItem">createItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-createPantry">createPantry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-createShoppingList">createShoppingList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-deleteItem">deleteItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-deletePantry">deletePantry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-deleteShoppingList">deleteShoppingList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updateItem">updateItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updatePantry">updatePantry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updateShoppingList">updateShoppingList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getItem">getItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getPantry">getPantry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getShoppingList">getShoppingList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-listItems">listItems</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-listPantries">listPantries</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-listShoppingLists">listShoppingLists</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onCreateItem">onCreateItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onCreatePantry">onCreatePantry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onCreateShoppingList">onCreateShoppingList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onDeleteItem">onDeleteItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onDeletePantry">onDeletePantry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onDeleteShoppingList">onDeleteShoppingList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onUpdateItem">onUpdateItem</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onUpdatePantry">onUpdatePantry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onUpdateShoppingList">onUpdateShoppingList</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components">components</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Card">Card</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-CustomDrawer">CustomDrawer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Header">Header</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Heading">Heading</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#screens">screens</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AboutScreen">AboutScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AccountsScreen">AccountsScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendEmail">sendEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AddItemScreen">AddItemScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AddShoppingListItemScreen">AddShoppingListItemScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-BarcodeAddScreen">BarcodeAddScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-CreatePantryScreen">CreatePantryScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-CreditsScreen">CreditsScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GlobalText">GlobalText</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-HelpScreen">HelpScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-HomeStackScreen">HomeStackScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ManualAddScreen">ManualAddScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-MyInfoScreen">MyInfoScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-NotificationsScreen">NotificationsScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-OtherPantryScreen">OtherPantryScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ProfileScreen">ProfileScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SettingsStackScreen">SettingsStackScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ShoppingStackScreen">ShoppingStackScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-WelcomeScreen">WelcomeScreen</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-customTheme">customTheme</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">SmartPantry/screens/Home.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import React, { useState, useEffect, useRef } from &quot;react&quot;;
import {Text,View ,ScrollView, Modal, Alert, Animated, PanResponder} from &quot;react-native&quot;;
import { createStackNavigator } from &quot;@react-navigation/stack&quot;;
import {Auth, API, graphqlOperation} from &apos;aws-amplify&apos;;
import {Icon, Input} from &apos;react-native-elements&apos;;
import { Button } from &quot;react-native-elements&quot;;
import { getPantry } from &quot;../queries&quot;;
import CreatePantryScreen from &quot;./CreatePantry&quot;;
import AddItemScreen from &quot;./AddItem&quot;;
import ManualAddScreen from &quot;./ManualAdd&quot;;
import { listItems, getItem } from &quot;../queries.js&quot;;
import { createItem, deleteItem, updateItem, createShoppingList, updatePantry } from &quot;../mutations&quot;;
import BarcodeAddScreen from &quot;./BarcodeAdd&quot;;
import * as Notifications from &apos;expo-notifications&apos;;
import Constants from &apos;expo-constants&apos;;


// Creates a stack navigator object
const HomeStack = createStackNavigator();

// Allows the nesting of bottom tab and stack navigation
// Contains all the screens that are reachable/within the bottom tab home screen

/**
 * @author Ryan Mraz
 * @returns Manages the Home stack, including AddItemScreen, CreatePantryScreen, ManualAddScreen, and BarcodeAddScreen
 */
const HomeStackScreen = () =&gt; {
    return (
      &lt;HomeStack.Navigator screenOptions={{
        headerBackTitleVisible: false
      }}&gt;
        &lt;HomeStack.Screen
          options={{ headerShown: false }}
          name=&quot;HomeStack&quot;
          component={HomeScreen}
        /&gt;
        &lt;HomeStack.Screen
          options={{ headerShown: true, title: &quot;Create Pantry&quot; }}
          name=&quot;CreatePantry&quot;
          component={CreatePantryScreen}
        /&gt;
        &lt;HomeStack.Screen
          options={{ headerShown: true, title: &quot;Add Item&quot;, headerStyle: {backgroundColor: &apos;#b5e48c&apos;}
        }}
          name=&quot;AddItem&quot;
          component={AddItemScreen}
        /&gt;
        &lt;HomeStack.Screen
          options={{ headerShown: true, title: &quot;Manual Add&quot; }}
          name=&quot;ManualAdd&quot; 
          component={ManualAddScreen}
        /&gt;
        &lt;HomeStack.Screen
          options={{ headerShown: true, title: &quot;Barcode Add&quot; }}
          name=&quot;BarcodeAdd&quot;
          component={BarcodeAddScreen}
        /&gt;
      &lt;/HomeStack.Navigator&gt;
    );
}


// The actual home screen rendering
/**
 * @author Ryan Mraz
 * @author Kollin Labowski
 * @param navigation - used for navigating from the Home stack. 
 * @returns Displays items and related information for the current user&apos;s pantry, AND manages notifications for the user&apos;s device.
 */
const HomeScreen = ({ navigation }) =&gt; {

  //NOTIFICATION STUFF
  try {
    const [expoPushToken, setExpoPushToken] = useState(&apos;&apos;);
    const [notification, setNotification] = useState(false);
    const notificationListener = useRef();
    const responseListener = useRef();

    useEffect( () =&gt; {
      registerForPushNotificationsAsync().then(token =&gt; setExpoPushToken(token));

      notificationListener.current = Notifications.addNotificationReceivedListener(notification =&gt; {
        setNotification(notification);
      });

      responseListener.current = Notifications.addNotificationResponseReceivedListener(response =&gt; {
        console.log(&quot;User has clicked notification&quot;);
        //If we ever want the notification page to redirect the user to a particular screen, we could do that here
        // console.log(response);
        console.log(response.notification.request.content.data.data);
      });

      return () =&gt; {
        Notifications.removeNotificationSubscription(notificationListener.current);
        Notifications.removeNotificationSubscription(responseListener.current);
      };
    }, []);
  } catch(err) {
    console.log(err);
  }

  //NOTE: There are still occaisionally some weird bugs where the user will receive double notifications,
  //but to fix could comment out the following lines. However, the trade-off is that the user will not
  //have their notifications renewed unless they actually click a button on the home page. May make more
  //updates in the next few days (4/12/2022)

  if(Date.now() % 5 == 0) {
    schedulePushNotification();  
  }
  //END NOTIFICATION STUFF

  // useState variables to track whether to render the create pantry button
  // the value of the pantry items, and if a user has a pantry.
  const [createPantryButton, setCreatePantryButton] = useState(null);
  const [items, setItems] = useState([]);
  const [pantryExists, setPantryExists] = useState(false);
  const [pantryName, setPantryName] = useState(&quot;&quot;);
  const [nameText, setNameText] = useState(&quot;&quot;);
  const [weightText, setWeightText] = useState(&quot;&quot;);
  const [quantityText, setQuantityText] = useState(&quot;&quot;);
  const [itemId, setItemId] = useState(null);

   const [isModalVisible, setIsModalVisible] = useState(false);

   const handleModal = () =&gt; setIsModalVisible(() =&gt; !isModalVisible);

  // Loads when you come back to this screen
  // refreshes each time you go back to the screen
  // Checks if a pantry exists and fetches the user&apos;s items on every load
  useEffect(() =&gt; {
    const unsubscribe = navigation.addListener(&quot;focus&quot;, () =&gt; {
      checkIfPantryExists();
      fetchItems();
    });
    return unsubscribe;
  }, [navigation, items]);

  // fetches just the items of the pantry that belongs to the current authenticated user
  const fetchItems = async () =&gt; {
    try {
      const user = await Auth.currentAuthenticatedUser(); // returns cognito user JSON

      // Performs the getPantry query based on the id, which is the user&apos;s username
      const pantryData = await API.graphql(
        graphqlOperation(getPantry, { id: user.username.toString() })
      );

      // if the getPantry query does not return a null value, sets pantry exists to true
      // otherwise sets it to false because they don&apos;t have a pantry yet
      if (pantryData.data.getPantry == null) {
        setPantryExists(false);
      } else {
        setPantryExists(true);
        setPantryName(pantryData.data.getPantry.name);

        // Grabs the id field from the pantry data
        const pantryId = pantryData.data.getPantry.id;

        // Grabs the items that are related to the id of the pantry
        const itemsList = await API.graphql(
          graphqlOperation(listItems, {
            filter: {
              pantryItemsId: {
                eq: pantryId.toString(),
              },
            },
          })
        );

        // stores the value of the items returned
        const b = itemsList.data.listItems.items;

        // changes the value of useState items value
        setItems(b);
      }
    } catch (err) {
      console.log(err);
    }
  };

  // Update item
  const updatePantryItem = async () =&gt; {

    const item = await API.graphql(graphqlOperation(getItem, {id: itemId}));

    // if item is updated to have 0 or less quantity, the item will automatically be deleted
    if (!(item.data.getItem.quantity == null) &amp;&amp; parseInt(quantityText) &lt;= 0) {
      deletePantryItem(itemId);
      handleModal();
      return;
    }

    // if item percentage goes to 0 or below, item automatically delete
    if (
      !(item.data.getItem.weight == null) &amp;&amp;
      (parseFloat(weightText) / parseFloat(item.data.getItem.weight)) &lt;= 0
    )
    {
      deletePantryItem(itemId);
      handleModal();
      return;
    }
      try {
        // Perform
        const update = {
          id: itemId,
          name: nameText ? nameText : item.name,
          currWeight: weightText
            ? parseFloat(weightText)
            : item.data.getItem.weight,
          quantity: quantityText
            ? parseInt(quantityText)
            : item.data.getItem.quantity,
        };

        const u = await API.graphql(
          graphqlOperation(updateItem, { input: update })
        );
        setNameText(&quot;&quot;);
        setWeightText(&quot;&quot;);
        setQuantityText(&quot;&quot;);
        fetchItems();
        handleModal();
      } catch (err) {}
  }

  // delete item
  const deletePantryItem = async (deleteId) =&gt; {
    try {
      const id = {
        id: deleteId
      }
      const d = await API.graphql(graphqlOperation(deleteItem,{input: id} ));
      fetchItems();
    } catch (err) { 
      console.log(err);
    }
  }

  // add an item to the shopping list upon deleting it from the pantry, if the user wishes
  const addToShoppingList = async (itemID, name) =&gt; {
    try {
      const user = await Auth.currentAuthenticatedUser();

      const id = {
        id: itemID,
        name: name,
        imagePath: &quot;default_img&quot;,
        shoppingListItemsId: user.username.toString()
      }
      const d = await API.graphql(graphqlOperation(createItem,{input: id} ));
    } catch (err) { 
      console.log(err);
    }
  }

  const modalScreen = (
    &lt;Modal visible={isModalVisible} animationType=&quot;slide&quot;&gt;
      &lt;View style={{ flex: 1, alignItems: &quot;center&quot;, justifyContent: &quot;center&quot; }}&gt;
        &lt;Text style={{fontSize: 25, fontWeight: &quot;bold&quot;, margin: 10}}&gt;Edit your item&lt;/Text&gt;
        &lt;Input
          placeholder=&quot;Name&quot;
          containerStyle={{ width: 250 }}
          onChangeText={(value) =&gt; setNameText(value)}
        /&gt;
        &lt;Input
          placeholder=&quot;Current Weight (optional)&quot;
          containerStyle={{ width: 250 }}
          onChangeText={(value) =&gt; setWeightText(value)}
        /&gt;
        &lt;Input
          placeholder=&quot;Quantity (optional)&quot;
          containerStyle={{ width: 250 }}
          onChangeText={(value) =&gt; setQuantityText(value)}
        /&gt;
        &lt;Button
          buttonStyle={{ width: 200, margin: 20}}
          title=&quot;Submit&quot;
          onPress={() =&gt; {
            updatePantryItem();
          }}
        &gt;&lt;/Button&gt;
        &lt;Button buttonStyle={{width: 200}} title=&quot;Go back&quot; onPress={handleModal}&gt;&lt;/Button&gt;
      &lt;/View&gt;
    &lt;/Modal&gt;
  );

  // list of items from pantry
  const listOfItems = items.map((item) =&gt; {
    let percentage = (parseFloat(item.currWeight) / parseFloat(item.weight) * 100).toFixed(2);
    return (
      &lt;View key={item.id}&gt;
        &lt;View
          style={{
            flexDirection: &quot;row&quot;,
            alignItems: &quot;center&quot;,
            justifyContent: &quot;center&quot;,
            paddingHorizontal: 20,
            paddingBottom: 20,
            paddingTop: 20,
          }}
        &gt;
          &lt;Text
            style={{paddingLeft: 15, width: &quot;50%&quot;, flexDirection: &quot;column&quot;, fontSize: 18 }}
          &gt;
            {item.name + &apos;\n&apos;}
            {item.quantity &amp;&amp; &lt;Text style={{fontSize: 15, fontWeight: &apos;bold&apos;}}&gt;Quantity: {item.quantity + &quot;\n&quot;}&lt;/Text&gt;}
            {item.weight &amp;&amp; &lt;Text style={{fontSize: 15, fontWeight: &quot;bold&quot;}}&gt;Percentage left: {percentage + &quot;%\n&quot;}&lt;/Text&gt;}
            {item.expDate &amp;&amp; &lt;Text style={{fontSize: 15, fontWeight: &quot;bold&quot;}}&gt;Expiration date: {item.expDate.substring(item.expDate.length - 8, item.expDate.length - 6) + &quot;/&quot; + item.expDate.substring(item.expDate.length - 6, item.expDate.length - 4) + &quot;/&quot; + item.expDate.substring(item.expDate.length - 4, item.expDate.length)}&lt;/Text&gt;}
          &lt;/Text&gt;
          &lt;Button buttonStyle={{ backgroundColor: &apos;grey&apos;, width: 75, marginRight: 5 }} title=&quot;update&quot; onPress={() =&gt; {
            setItemId(item.id);
            handleModal();
            schedulePushNotification();
          }}&gt;
          &lt;/Button&gt;
          &lt;Button  buttonStyle={{backgroundColor: &apos;red&apos;, width: 75, marginRight: 5}} title=&quot;delete&quot; onPress={() =&gt; {
             Alert.alert(&quot;Delete Item&quot;, &quot;Are you sure you want to delete item?&quot;, [
               {
                 text: &quot;Yes&quot;,
                 onPress: () =&gt; { 
                  schedulePushNotification();
                   Alert.alert(&quot;Shopping List&quot;, &quot;Would you like to add the item to your shopping list?&quot;, [
                     {
                       text: &quot;Yes&quot;,
                       onPress: () =&gt; {
                         const itemID = item.id;
                         const name = item.name;
                         Alert.alert(&quot;Shopping List&quot;, &quot;Adding to shopping list: &quot; + name);
                         deletePantryItem(item.id);
                         addToShoppingList(itemID, name);
                       }
                     },
                     {
                      text: &quot;No&quot;,
                      onPress: () =&gt; {
                        deletePantryItem(item.id);
                      },
                     },
                 ] );
                },
               },
               {
                 text: &quot;No&quot;,
                 style: &quot;cancel&quot;,
               },
               
             ]);
          }}&gt;&lt;/Button&gt;
        &lt;/View&gt;
        &lt;View style={{ height: 1.2, backgroundColor: &quot;grey&quot; }} /&gt;
      &lt;/View&gt;
    );
  });


  // checks whether or not a user has a pantry yet
  const checkIfPantryExists = async () =&gt; {
    try {
      const user = await Auth.currentAuthenticatedUser(); // grabs current user&apos;s information

      // Performs the getPantry query based on user&apos;s id
      const pantryData = await API.graphql(
        graphqlOperation(getPantry, { id: user.username.toString() })
      );

      // If it&apos;s null, we want to render the create pantry button
      // otherwise, we want to hide it
      if (pantryData.data.getPantry == null) {
        setCreatePantryButton(true);
      } else {
        setCreatePantryButton(null);
      }
    } catch (err) {
      console.log(err);
    }
  };

  return (
      &lt;ScrollView
        contentContainerStyle={{
           flexGrow: 1,
          alignItems: &quot;center&quot;,
          justifyContent: &quot;center&quot;,
          backgroundColor: &apos;#b5e48c&apos;
        }}
      &gt;
        {!pantryExists}
        {/* Conditional render based on the value of createPantryButton and pantryExists */}
        {createPantryButton &amp;&amp; (         
          &lt;Button
              buttonStyle={{                  
                backgroundColor:&apos;#3D405B&apos;,
                borderRadius:10,
                borderWidth: 1,
                borderColor: &apos;#fff&apos; }}
              title=&quot;Create Pantry&quot;
              onPress={() =&gt; {
                navigation.navigate(&quot;CreatePantry&quot;);
                schedulePushNotification();              }}
            &gt;&lt;/Button&gt;
        )}
        {pantryExists &amp;&amp; (
          &lt;View
            style={{ flex: 1, alignItems: &quot;center&quot;, justifyContent: &quot;center&quot; }}
          &gt;
            &lt;Text style={{ fontSize: 25, margin: 15 }}&gt;{pantryName}&lt;/Text&gt;
            &lt;Button
              buttonStyle={{ marginTop:10,
                paddingTop:15,
                paddingBottom:15,
                marginLeft:30,
                marginRight:30,
                backgroundColor:&apos;#3D405B&apos;,
                borderRadius:10,
                borderWidth: 1,
                borderColor: &apos;#fff&apos; }}
              title=&quot;Add Item&quot;
              onPress={() =&gt; {
                navigation.navigate(&quot;AddItem&quot;);
                schedulePushNotification();
              }}
            &gt;&lt;/Button&gt;


            
            &lt;View&gt;{listOfItems}&lt;/View&gt;
            &lt;View&gt;{modalScreen}&lt;/View&gt;
          &lt;/View&gt;
        )}
      &lt;/ScrollView&gt;
  );
};

/**
 * @author Kollin Labowski
 * @returns An expo token for the user to show that the user has registered for notifications through Expo
 */
async function registerForPushNotificationsAsync() {
  let token;
  if (Constants.isDevice) {
    const { status: existingStatus } = await Notifications.getPermissionsAsync();
    let finalStatus = existingStatus;
    if (existingStatus !== &apos;granted&apos;) {
      const { status } = await Notifications.requestPermissionsAsync();
      finalStatus = status;
    }
    if (finalStatus !== &apos;granted&apos;) {
      alert(&apos;Failed to get push token for push notification!&apos;);
      return;
    }
    token = (await Notifications.getExpoPushTokenAsync()).data;
    console.log(token);
  } else {
    alert(&apos;Must use physical device for Push Notifications&apos;);
  }

  if (Platform.OS === &apos;android&apos;) {
    Notifications.setNotificationChannelAsync(&apos;default&apos;, {
      name: &apos;default&apos;,
      importance: Notifications.AndroidImportance.MAX,
      vibrationPattern: [0, 250, 250, 250],
      lightColor: &apos;#FF231F7C&apos;,
    });
  }

  return token;
}

async function schedulePushNotification() {

  const user = await Auth.currentAuthenticatedUser(); // grabs current user&apos;s information

  const pantryData = await API.graphql(
    graphqlOperation(getPantry, { id: user.username.toString() })
  );

  if (pantryData.data.getPantry == null) {
    console.log(&quot;User has no pantry&quot;);
  }
  else {
    //NOTE: The frequency update field stores the number of seconds between timestamps

    //MAKE CHANGE HERE!!! Convert from string to long, then do Math.floor(notifTime / 1000)
    if(Math.floor(parseInt(pantryData.data.getPantry.notifTime) / 1000) + pantryData.data.getPantry.notiffreq &lt; Math.floor(Date.now() / 1000) &amp;&amp; pantryData.data.getPantry.notifPending) {
      console.log(&quot;Allowing notifications again&quot;);
      const pantryInput = {
        id: user.username.toString(),
        notifPending: false,
        notifTime: Math.floor(Date.now() / 1000),
      };
      const p = await API.graphql(graphqlOperation(updatePantry, {input: pantryInput}))
    }

    let itemsExpiring = 0;
    const today = new Date();

    //HERE: Check if there are any items expiring in the current user&apos;s pantry
    // Grabs the id field from the pantry data
    const pantryId = pantryData.data.getPantry.id;

    // Grabs the items that are related to the id of the pantry
    const itemsList = await API.graphql(
      graphqlOperation(listItems, {
        filter: {
          pantryItemsId: {
            eq: pantryId.toString(),
          },
        },
      })
    );

    const b = itemsList.data.listItems.items;

    const checkExpirations = b.map( async (item) =&gt; {
      //NOTE: For some reason, the JavaScipt Date function is outputting the wrong date for me. I can calibrate it to be accurate
      //      but I don&apos;t want to do that until closer to when we demo our project.
      // console.log(&quot;DATE: &quot; + item.expDate);
      // console.log(&quot;MONTH: &quot; + today.getMonth() + &quot; &quot; + today.getDay() + &quot; &quot; + today.getFullYear());
      const exp_date = item.expDate;
      if(exp_date != null) {

        let month = 0;
        let day = 0;
        let year = 0;
        // console.log(&quot;EXP DATE: &quot; + exp_date);
        if(exp_date.length == 7) {
          month = parseInt(exp_date.charAt(0));
          day = parseInt(exp_date.substring(1,3));
          year = parseInt(exp_date.substring(3,7));
          // console.log(month + &quot; &quot; + day + &quot; &quot; + year);
        }
        else if(exp_date.length == 8) {
          month = parseInt(exp_date.substring(0,2));
          day = parseInt(exp_date.substring(2,4));
          year = parseInt(exp_date.substring(4,8));
          // console.log(month + &quot; &quot; + day + &quot; &quot; + year);
        }
        // console.log(&quot;FULL YEAR&quot;, today.getFullYear() + &quot; &quot; + year);

        //Handle if at the end of a year
        if(today.getMonth() == 12) {
          if(month == 12) {
            if(today.getDay() &lt;= day) {
              itemsExpiring += 1;
            }
          }
          if(month == 1 &amp;&amp; today.getFullYear() + 1 == year) {
            if(day &lt;= 15) {
              itemsExpiring += 1;
            }
          }
        }//Next handle the general case
        else if(today.getFullYear() == year) {
          if(today.getMonth() == month &amp;&amp; today.getDay() &lt;= day) {
            itemsExpiring += 1;
          }
          else if(today.getMonth() + 1 == month &amp;&amp; today.getDay() &gt; 15 &amp;&amp; day &lt;= 15) {
            itemsExpiring += 1;
          }
        }
      }
    });

    let runningLow = 0;

    // console.log(&quot;CHECKING ITEMS&quot;);
    const checkRunningLow = b.map( async (item) =&gt; {
      // console.log(&quot;ITEM: &quot; + item.name);
      let alreadyCounted = false;

      if(item.weight != null) {
        if(item.currWeight &lt; item.weight * 0.3) {
          runningLow += 1;
          alreadyCounted = true;
          // console.log(&quot;WEIGHT RUNNING LOW&quot;);
        }
      }
      if(item.quantity != null &amp;&amp; !alreadyCounted) {
        if(item.quantity &lt;= 2 || item.quantity &lt; item.origQuantity * 0.3) {
          runningLow += 1;
          // console.log(&quot;QUANTITY RUNNING LOW&quot;);
        }
      }
    });

    // if(itemsExpiring &gt; 0) {
    //   console.log(&quot;User has items expiring soon&quot;);
    // }
    // else {
    //   console.log(&quot;User has no items expiring soon&quot;);
    // }

    // if(runningLow &gt; 0) {
    //   console.log(&quot;User has items running low&quot;);
    // }
    // else {
    //   console.log(&quot;User has no items running low&quot;);
    // }

    if(!pantryData.data.getPantry.notifPending &amp;&amp; (itemsExpiring &gt; 0 || runningLow &gt; 0)) {
      console.log(&quot;Scheduling notification&quot;);

      const newestPantryData = await API.graphql(
        graphqlOperation(getPantry, { id: user.username.toString() })
      );

      const curr_time = Date.now();

      let test = &quot;&quot; + curr_time;

      // console.log(&quot;curr_time: &quot; + test);

      const pantryInput = {
        id: user.username.toString(),
        notifPending: true,
        notifTime: test,
      };

      const old_time = newestPantryData.data.getPantry.notifTime
      // console.log(&quot;OLD: &quot; + old_time + &quot; NEW: &quot; + test);

      if(parseInt(old_time) + 1000 &lt; curr_time) { // The purpose here is to prevent the user from getting multiple notifications at once
        
        const p = await API.graphql(graphqlOperation(updatePantry, {input: pantryInput}))
        // console.log(&quot;NEW TIME: &quot; + test);
        // console.log(&quot;ADDING&quot;);
        // console.log(&quot;Scheduling notification&quot;);
        // console.log(newestPantryData.data.getPantry.notifTime + &apos; &apos; + curr_time);

        if(itemsExpiring &gt; 0 &amp;&amp; runningLow &lt;= 0) {
          await Notifications.scheduleNotificationAsync({
            content: {
              title: &quot;SMART PANTRY&quot;,
              body: &apos;You have &apos; + itemsExpiring + &apos; item(s) expiring soon! Click here to view them.&apos;,
              data: { data: &apos;View home menu&apos; },
            },
            trigger: { seconds: pantryData.data.getPantry.notiffreq },
          });
        }
        else if(itemsExpiring &lt;= 0 &amp;&amp; runningLow &gt; 0) {
          await Notifications.scheduleNotificationAsync({
            content: {
              title: &quot;SMART PANTRY&quot;,
              body: &apos;You have &apos; + runningLow + &apos; item(s) running low! Click here to view them.&apos;,
              data: { data: &apos;View home menu&apos; },
            },
            trigger: { seconds: pantryData.data.getPantry.notiffreq },
          });
        }
        else {
          await Notifications.scheduleNotificationAsync({
            content: {
              title: &quot;SMART PANTRY&quot;,
              body: &apos;You have &apos; + itemsExpiring + &apos; item(s) expiring soon and &apos; + runningLow + &apos; item(s) running low! Click here to view them.&apos;,
              data: { data: &apos;View home menu&apos; },
            },
            trigger: { seconds: pantryData.data.getPantry.notiffreq },
          });
        }
      }
    }
  }
}

export default HomeStackScreen;

</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
